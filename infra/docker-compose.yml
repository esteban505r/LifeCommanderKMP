version: '3'
services:
  nginx:
    image: nginx:1.27-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      oter:
        condition: service_started
    restart: always
    networks:
      - edge
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  oter:
    image: ${IMAGE_REPO}:${IMAGE_TAG}
    environment:
      PORT: "8080"
      LOG_LEVEL: INFO
      AWS_REGION: us-east-1
      RDS_INSTANCE_ID: ${RDS_INSTANCE_ID}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      # Sentry configuration
      SENTRY_DSN: ${SENTRY_DSN:-}
      ENVIRONMENT: ${ENVIRONMENT:-production}
    volumes:
      - ./.env:/app/.env
    expose:
      - "8080"
    restart: unless-stopped
    networks:
      - edge
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  edge:
    external: true
